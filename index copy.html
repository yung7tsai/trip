<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Seoul Trip 2026</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Serif+KR:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
      :root {
        --bg-paper: #f8fafb;
        --text-primary: #1f3a52; /* Ê∑±ÊôÆÈ≠ØÂ£´Ëóç */
        --text-secondary: #537791;
        --text-accent: #8aa6bf;
        --bg-white: #ffffff;
        --border-color: #e0e0e0;

        --font-main: "Noto Serif KR", "Noto Serif TC", serif;
        --font-num: "Playfair Display", serif;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0 auto;
        max-width: 480px;
        min-height: 100vh;
        font-family: var(--font-main);
        background-color: var(--bg-paper);
        color: var(--text-primary);
        position: relative;
        padding-bottom: 120px;
      }

      /* --- Header --- */
      header {
        position: relative;
        min-height: 450px;
        background-image: url("https://images.unsplash.com/photo-1598983870677-01e226156732?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80");
        background-size: cover;
        background-position: top center;
        background-repeat: no-repeat;
        background-color: var(--bg-paper);
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        background: linear-gradient(
          to bottom,
          rgba(248, 250, 251, 0) 0%,
          rgba(248, 250, 251, 0.4) 30%,
          rgba(248, 250, 251, 0.95) 70%,
          rgba(248, 250, 251, 1) 100%
        );
        z-index: 1;
      }

      .header-content-wrapper,
      .date-section {
        position: relative;
        z-index: 2;
        padding: 0 24px;
      }

      .header-content-wrapper {
        padding-top: 140px;
        margin-bottom: 20px;
      }

      .date-display {
        font-family: var(--font-num);
        font-size: 15px;
        letter-spacing: 1px;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .real-time {
        font-family: var(--font-num);
        font-size: 76px;
        line-height: 1;
        color: var(--text-primary);
        margin-bottom: 15px;
        font-weight: 500;
        text-shadow: 0 10px 30px rgba(248, 250, 251, 0.8);
      }

      .trip-title {
        font-size: 34px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: 2px;
        margin-bottom: 15px;
      }

      .info-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .location-badge,
      .weather-widget {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
        background: rgba(255, 255, 255, 0.6);
        padding: 8px 14px;
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        font-weight: 600;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
      }
      .weather-widget {
        gap: 8px;
      }
      .weather-temp {
        font-family: var(--font-num);
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* --- Date Area --- */
      .date-section {
        padding-bottom: 25px;
      }
      .date-tabs {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scrollbar-width: none;
        padding: 5px;
      }
      .date-tabs::-webkit-scrollbar {
        display: none;
      }

      .tab {
        min-width: 68px;
        height: 75px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 1);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(31, 58, 82, 0.05);
        backdrop-filter: blur(5px);
      }
      .tab.active {
        background: var(--text-primary);
        color: #fff;
        border-color: var(--text-primary);
        box-shadow: 0 8px 25px rgba(31, 58, 82, 0.25);
        transform: translateY(-3px);
      }
      .tab span:first-child {
        font-size: 12px;
        font-family: var(--font-num);
        margin-bottom: 5px;
        opacity: 0.9;
      }
      .tab span:last-child {
        font-size: 18px;
        font-weight: 600;
        font-family: var(--font-num);
      }

      /* --- Timeline & Card Êñ∞Ê®£Âºè --- */
      .timeline-container {
        padding: 30px 24px;
        position: relative;
        background: var(--bg-paper);
        border-top: 1px solid #eef2f5;
      }
      /* Â∑¶ÂÅ¥ÂûÇÁõ¥Á∑ö */
      .timeline-container::before {
        content: "";
        position: absolute;
        left: 35px;
        top: 30px;
        bottom: 0;
        width: 2px;
        background: #e0e0e0;
        z-index: 0;
      }

      .timeline-item {
        display: flex;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
        padding-left: 30px; /* ÈÖçÂêàÂ∑¶ÂÅ¥Á∑öÊ¢ùÁ∏ÆÊéí */
      }

      /* ÂúìÈªû */
      .timeline-item::before {
        content: "";
        position: absolute;
        left: 6px;
        top: 25px;
        width: 10px;
        height: 10px;
        background: var(--text-primary);
        border-radius: 50%;
        z-index: 2;
        border: 2px solid var(--bg-paper);
      }

      /* Âç°ÁâáÊú¨È´î */
      .card {
        flex: 1;
        background: #fff;
        padding: 20px;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border-left: 4px solid var(--text-primary); /* Â∑¶ÂÅ¥Ê∑±Ëâ≤Á≤óÁ∑ö */
        cursor: grab;
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
      }
      .card:active {
        cursor: grabbing;
        transform: scale(0.99);
      }

      /* Á¨¨‰∏ÄË°åÔºöÊôÇÈñì + Ê®ôÁ±§ + ÂÉπÊ†ºÊ°Ü */
      .card-top-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      .card-time {
        font-family: var(--font-num);
        font-size: 24px;
        font-weight: 500;
        color: var(--text-primary);
        margin-right: 12px;
        line-height: 1;
      }
      .card-tag {
        font-size: 11px;
        padding: 3px 8px;
        background: #4a6e87;
        color: #fff;
        border-radius: 4px;
        font-weight: 500;
        letter-spacing: 1px;
      }
      .card-price-box {
        margin-left: auto; /* Êé®Âà∞ÊúÄÂè≥ÈÇä */
        border: 1px solid var(--text-primary);
        padding: 2px 8px;
        font-family: var(--font-num);
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
      }

      /* Á¨¨‰∫åË°åÔºöÂ§ßÊ®ôÈ°å */
      .card-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 15px;
        line-height: 1.4;
        letter-spacing: 0.5px;
      }

      /* ÂÖßÂÆπËàáÂúñÁâá */
      .card-detail {
        font-size: 14px;
        color: #7a92a5;
        line-height: 1.6;
        margin-bottom: 10px;
        white-space: pre-line;
      }
      .card-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
        display: none;
      }

      /* ÊúÄ‰∏ãÊñπÔºöÂú∞ÂúñÊêúÂ∞ãÂàó */
      .card-map-row {
        border-top: 1px solid #eee;
        padding-top: 12px;
        margin-top: auto;
      }
      .map-link {
        text-decoration: none;
        color: #666;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
      }
      .map-link:hover {
        color: var(--text-primary);
      }

      .price-badge {
        font-family: var(--font-num);
        font-weight: 700;
        color: var(--text-primary);
        font-size: 15px;
      }

      /* --- Footer --- */
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        padding: 16px 24px;
        border-top: 1px solid #eef2f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 480px;
        margin: 0 auto;
        z-index: 100;
      }
      .total-price {
        font-family: var(--font-num);
        font-size: 24px;
        color: var(--text-primary);
        font-weight: 700;
      }
      .fab {
        width: 52px;
        height: 52px;
        background: var(--text-primary);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        box-shadow: 0 8px 25px rgba(31, 58, 82, 0.3);
        cursor: pointer;
      }

      /* --- Modal (Á∑äÊπäÁâàÊ®£Âºè) --- */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(31, 58, 82, 0.4);
        z-index: 200;
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      }
      .modal-box {
        background: #fff;
        width: 90%;
        max-width: 380px;
        padding: 20px; /* Á∏ÆÂ∞èÂÖßË∑ù */
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        border-radius: 16px;
        max-height: 95vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .modal-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .btn-delete {
        color: #e74c3c;
        background: none;
        border: none;
        font-size: 13px;
        cursor: pointer;
      }

      /* Á∑äÊπäÊéíÂàóË®≠ÂÆö */
      .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      .input-group {
        margin-bottom: 8px;
        flex: 1;
      }
      .input-group label {
        display: block;
        font-size: 11px;
        color: #888;
        margin-bottom: 4px;
        font-weight: 600;
      }

      .modal-input,
      .modal-select,
      .modal-textarea {
        width: 100%;
        padding: 8px 10px; /* Á∏ÆÂ∞èËº∏ÂÖ•Ê°ÜÈ´òÂ∫¶ */
        border: 1px solid #e0e0e0;
        font-family: var(--font-main);
        border-radius: 6px;
        background: #fafcfd;
        font-size: 14px;
      }
      .modal-textarea {
        resize: vertical;
        min-height: 50px; /* Á∏ÆÂ∞èÂÇôË®ªÊ¨ÑÈ´òÂ∫¶ */
      }
      .modal-input:focus,
      .modal-select:focus,
      .modal-textarea:focus {
        border-color: var(--text-primary);
        background: #fff;
        outline: none;
      }

      .file-upload-wrapper {
        position: relative;
        margin-bottom: 8px;
        border: 1px dashed #ccc;
        border-radius: 6px;
        padding: 12px; /* Á∏ÆÂ∞è‰∏äÂÇ≥ÂçÄ */
        text-align: center;
        cursor: pointer;
        background: #fafcfd;
      }
      .file-preview {
        max-width: 100%;
        max-height: 100px;
        margin-top: 5px;
        display: none;
        border-radius: 4px;
      }

      .btn-save {
        width: 100%;
        padding: 12px;
        background: var(--text-primary);
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        margin-top: 5px;
      }

      /* --- Ê∂àË≤ªÊòéÁ¥∞Ë¶ñÁ™óÊ®£Âºè (Êñ∞Â¢û) --- */
      .expense-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .expense-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f3a52;
        border-bottom: 3px solid #1f3a52;
        display: inline-block;
        padding-bottom: 5px;
      }
      .expense-subtitle {
        font-size: 13px;
        color: #888;
        margin-top: 8px;
      }

      .expense-list {
        border-top: 1px dotted #ccc;
        border-bottom: 1px dotted #ccc;
        padding: 15px 0;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
      }
      .expense-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px dotted #eee;
      }
      .expense-name {
        font-size: 15px;
        color: #333;
      }
      .expense-amount {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: #333;
        margin-right: 10px;
      }
      .btn-remove-expense {
        color: #ccc;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 18px;
      }
      .btn-remove-expense:hover {
        color: #e74c3c;
      }

      .expense-input-area {
        background: #fafcfd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #eee;
      }
      .expense-input-row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .btn-add-expense {
        background: #1f3a52;
        color: white;
        border: none;
        border-radius: 4px;
        width: 60px;
        cursor: pointer;
      }

      .expense-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        font-weight: 700;
        border-top: 2px solid #1f3a52;
        padding-top: 15px;
      }
      .expense-total-amount {
        font-family: "Playfair Display", serif;
        color: #1f3a52;
        font-size: 22px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content-wrapper">
        <div class="date-display" id="currentDate">Loading...</div>
        <div class="real-time" id="clock">00:00</div>
        <div class="trip-title">È¶ñÁàæ Seoul</div>

        <div class="info-row">
          <div class="location-badge" id="locationBadge">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span id="locationText">ÂÆö‰Ωç‰∏≠...</span>
          </div>
          <div class="weather-widget">
            <div class="weather-icon" id="weatherIcon">‚åõ</div>
            <div class="weather-temp" id="weatherTemp">--¬∞</div>
          </div>
        </div>
      </div>

      <div class="date-section">
        <div class="date-tabs" id="dateTabs"></div>
      </div>
    </header>

    <div class="timeline-container">
      <div
        style="
          text-align: right;
          font-size: 12px;
          color: var(--text-accent);
          margin-bottom: 20px;
          font-style: italic;
          font-weight: 500;
        "
      >
        ‚ú¶ Èï∑ÊåâÂç°ÁâáÂèØÊãñÊõ≥ÊéíÂ∫è
      </div>
      <div id="sortableList"></div>
    </div>

    <div class="footer">
      <div>
        <div
          style="
            font-size: 11px;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-bottom: 4px;
            font-weight: 600;
          "
        >
          ESTIMATED TOTAL
        </div>
        <div class="total-price" id="totalPrice">‚Ç© 0</div>
      </div>
      <div class="fab" onclick="openModal()">+</div>
    </div>

    <div
      class="modal-overlay"
      id="expenseModal"
      onclick="if(event.target===this) closeExpenseModal()"
    >
      <div class="modal-box">
        <div class="expense-header">
          <div class="expense-title">Ê∂àË≤ªÊòéÁ¥∞</div>
          <div class="expense-subtitle" id="expenseSubtitle">Ë°åÁ®ãÔºö--</div>
        </div>

        <div class="expense-list" id="expenseList"></div>

        <div class="expense-input-area">
          <div class="input-group" style="margin-bottom: 0">
            <input
              type="text"
              class="modal-input"
              id="newExpenseName"
              placeholder="È†ÖÁõÆÔºà‰æãÔºöÂçàÈ§êÔºâ"
              lang="zh-TW"
            />
          </div>
          <div class="expense-input-row">
            <input
              type="number"
              class="modal-input"
              id="newExpenseAmount"
              placeholder="ÈáëÈ°ç"
            />
            <button class="btn-add-expense" onclick="addExpense()">ÂÖ•Â∏≥</button>
          </div>
        </div>

        <div class="expense-total">
          <span>ÂêàË®à</span>
          <span class="expense-total-amount" id="expenseTotalDisplay">‚Ç© 0</span>
        </div>
      </div>
    </div>

    <div
      class="modal-overlay"
      id="editModal"
      onclick="if(event.target===this) closeModal()"
    >
      <div class="modal-box">
        <div class="modal-header">
          <div class="modal-title">Ë°åÁ®ãÁ∑®ËºØ</div>
          <button class="btn-delete" onclick="deleteItem()">üóë Âà™Èô§</button>
        </div>

        <input type="hidden" id="itemId" />

        <div class="input-row">
          <div class="input-group" style="flex: 0.6">
            <label>ÊôÇÈñì</label>
            <input type="time" class="modal-input" id="inputTime" />
          </div>
          <div class="input-group" style="flex: 1">
            <label>ÂàÜÈ°û</label>
            <select class="modal-select" id="inputCategory">
              <option value="‰∫§ÈÄö">‰∫§ÈÄö</option>
              <option value="ÂçàÈ§ê">ÂçàÈ§ê</option>
              <option value="ÊôöÈ§ê">ÊôöÈ§ê</option>
              <option value="Ë≥ºÁâ©ÈÄõË°ó">Ë≥ºÁâ©ÈÄõË°ó</option>
              <option value="ÊôØÈªû">ÊôØÈªû</option>
              <option value="ÂΩàÊÄß">ÂΩàÊÄß</option>
              <option value="ÊúâÈ†êÁ¥ÑÁöÑË°åÁ®ã">ÊúâÈ†êÁ¥ÑÁöÑË°åÁ®ã</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>Ê®ôÈ°å</label>
          <input
            type="text"
            class="modal-input"
            id="inputTitle"
            placeholder="‰æãÔºöÊòéÊ¥ûÊèõÈå¢"
          />
        </div>

        <div class="input-group">
          <label>Âú∞ÂúñÈÄ£Áµê (URL)</label>
          <input
            type="text"
            class="modal-input"
            id="inputMap"
            placeholder="Naver Map ÈÄ£Áµê"
          />
        </div>

        <div class="input-group">
          <label>ÂÇôË®ª</label>
          <textarea
            class="modal-textarea"
            id="inputMemo"
            placeholder="Ë©≥Á¥∞Ë≥áË®ä..."
          ></textarea>
        </div>

        <div class="input-group">
          <label>ÂúñÁâá (ÈªûÊìä‰∏äÂÇ≥)</label>
          <div
            class="file-upload-wrapper"
            onclick="document.getElementById('inputImage').click()"
          >
            <span style="font-size: 12px; color: #888">ÈÅ∏ÊìáÂúñÁâá</span>
            <input
              type="file"
              id="inputImage"
              style="display: none"
              accept="image/*"
              onchange="previewImage(this)"
            />
            <img id="imgPreview" class="file-preview" />
          </div>
        </div>

        <button class="btn-save" onclick="saveItem()">‰øùÂ≠òËÆäÊõ¥</button>
      </div>
    </div>

    <script>
      // --- ÂÖ®ÂüüËàá GPS ---
      let currentLat = 37.5665;
      let currentLon = 126.978;

      function initLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              currentLat = position.coords.latitude;
              currentLon = position.coords.longitude;
              fetchCityName(currentLat, currentLon);
              fetchWeather(currentLat, currentLon);
            },
            (error) => {
              document.getElementById("locationText").innerText =
                "È¶ñÁàæ (Default)";
              fetchWeather(currentLat, currentLon);
            }
          );
        } else {
          fetchWeather(currentLat, currentLon);
        }
      }

      async function fetchCityName(lat, lon) {
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=zh-TW`
          );
          const data = await res.json();
          let name =
            data.address.city ||
            data.address.town ||
            data.address.county ||
            "ÁõÆÂâç‰ΩçÁΩÆ";
          document.getElementById("locationText").innerText = name;
        } catch (e) {
          document.getElementById("locationText").innerText = "ÁõÆÂâç‰ΩçÁΩÆ";
        }
      }

      async function fetchWeather(lat, lon) {
        try {
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
          );
          const data = await res.json();
          const temp = Math.round(data.current_weather.temperature);
          const code = data.current_weather.weathercode;
          document.getElementById("weatherTemp").innerText = `${temp}¬∞C`;
          let icon = "‚òÄÔ∏è";
          if (code > 2) icon = "‚õÖ";
          if (code > 45) icon = "‚òÅÔ∏è";
          if (code > 50) icon = "üåßÔ∏è";
          if (code > 70) icon = "‚ùÑÔ∏è";
          document.getElementById("weatherIcon").innerText = icon;
        } catch (e) {}
      }

      initLocation();
      setInterval(() => fetchWeather(currentLat, currentLon), 600000);

      // --- ÊôÇÈñì ---
      function updateTime() {
        const now = new Date();
        document.getElementById("clock").innerText = `${String(
          now.getHours()
        ).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
        const dateStr = `${now.getFullYear()}.${String(
          now.getMonth() + 1
        ).padStart(2, "0")}.${String(now.getDate()).padStart(2, "0")}`;
        const dayStr = now.toLocaleDateString("en-US", { weekday: "short" });
        document.getElementById(
          "currentDate"
        ).innerText = `${dateStr} (${dayStr})`;
      }
      setInterval(updateTime, 1000);
      updateTime();

      // --- Ë≥áÊñôÁÆ°ÁêÜ (Êõ¥Êñ∞ÁâàÔºöËá™ÂãïÈÅ∑ÁßªËàäË≥áÊñô) ---
      const defaultData = [
        {
          id: 1,
          date: "1/6",
          time: "18:15",
          title: "TPE üõ´ ICN",
          category: "‰∫§ÈÄö",
          memo: "ÈÖ∑Ëà™ TR 896",
          expenses: [],
          mapUrl: "",
          image: "",
        },
      ];

      // --- Ë≤º‰∏äÈÄôÊÆµÊñ∞ÁöÑÔºåÂåÖÂê´Ë≥áÊñôËΩâÊèõÈÇèËºØ ---
      let rawData =
        JSON.parse(localStorage.getItem("seoul2026_text_v1")) || defaultData;

      // Ëá™ÂãïËΩâÊèõÔºöÂ¶ÇÊûú‰Ω†‰πãÂâçÊúâÂ≠òÈÅéÂñÆ‰∏Ä priceÔºåÈÄôË£°ÊúÉÂπ´‰Ω†ËΩâÊàê expenses Èô£Âàó
      let itinerary = rawData.map((item) => {
        if (!item.expenses) {
          // Â¶ÇÊûúËàäË≥áÊñôÊúâ price ‰∏îÂ§ßÊñº 0ÔºåËΩâÁÇ∫‰∏ÄÁ≠Ü„ÄåË≤ªÁî®„Äç
          if (item.price && item.price > 0) {
            item.expenses = [{ name: "Ë≤ªÁî®", amount: parseInt(item.price) }];
          } else {
            item.expenses = [];
          }
        }
        return item;
      });

      const dates = [
        { d: "1/6", w: "Day 1" },
        { d: "1/7", w: "Day 2" },
        { d: "1/8", w: "Day 3" },
        { d: "1/9", w: "Day 4" },
        { d: "1/10", w: "Day 5" },
        { d: "1/11", w: "Day 6" },
        { d: "1/12", w: "Day 7" },
      ];
      let currentDate = "1/6";

      function renderTabs() {
        document.getElementById("dateTabs").innerHTML = dates
          .map(
            (d) => `
                <div class="tab ${
                  d.d === currentDate ? "active" : ""
                }" onclick="switchDate('${d.d}')">
                    <span>${d.w}</span><span>${d.d}</span>
                </div>
            `
          )
          .join("");
      }

      function renderList() {
        const list = document.getElementById("sortableList");
        list.innerHTML = "";
        const items = itinerary.filter((i) => i.date === currentDate);

        // Ë®àÁÆóÂÖ®Â§©Á∏ΩÈáëÈ°ç (Á¥ØÂä†ÊâÄÊúâÊòéÁ¥∞)
        let grandTotal = 0;
        itinerary.forEach((i) => {
          if (i.expenses)
            grandTotal += i.expenses.reduce(
              (sum, e) => sum + parseInt(e.amount),
              0
            );
        });
        document.getElementById(
          "totalPrice"
        ).innerText = `‚Ç© ${grandTotal.toLocaleString()}`;

        if (items.length === 0)
          list.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa; font-size:14px;">ÈªûÊìäÂè≥‰∏ãËßí + Êñ∞Â¢ûË°åÁ®ã</div>`;

        items.forEach((item) => {
          // Ë®àÁÆóË©≤ÂñÆ‰∏ÄË°åÁ®ãÁöÑÁ∏ΩÈáëÈ°ç
          const itemTotal = item.expenses.reduce(
            (sum, e) => sum + parseInt(e.amount),
            0
          );

          const el = document.createElement("div");
          el.className = "timeline-item";
          el.dataset.id = item.id;

          const imgHtml = item.image
            ? `<img src="${item.image}" class="card-image" style="display:block;">`
            : "";

          // Âú∞ÂúñÈÄ£ÁµêÈÇèËºØ
          let mapLinkHtml = "";
          if (item.mapUrl) {
            let finalUrl = item.mapUrl;
            if (!finalUrl.startsWith("http"))
              finalUrl = `http://googleusercontent.com/maps.google.com/search?q=${encodeURIComponent(
                item.mapUrl
              )}`;
            mapLinkHtml = `<div class="card-map-row"><a href="${finalUrl}" target="_blank" class="map-link" onclick="event.stopPropagation()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>ÊêúÂ∞ãÂú∞ÂúñÔºö${
              item.mapUrl.length > 10 ? "Êü•Áúã‰ΩçÁΩÆ" : item.mapUrl
            }</a></div>`;
          }

          const priceText = `‚Ç© ${itemTotal.toLocaleString()}`;

          el.innerHTML = `
            <div class="card" onclick="editItem(${item.id})">
                <div class="card-top-row">
                    <span class="card-time">${item.time}</span>
                    <span class="card-tag">${item.category || "‰∫§ÈÄö"}</span>
                    <span class="card-price-box" onclick="openExpenseModal(${
                      item.id
                    }, event)">${priceText}</span>
                </div>
                
                <div class="card-title">${item.title}</div>
                ${imgHtml}
                <div class="card-detail">${item.memo}</div>
                ${mapLinkHtml}
            </div>
        `;
          list.appendChild(el);
        });
      }

      function switchDate(d) {
        currentDate = d;
        renderTabs();
        renderList();
      }
      new Sortable(document.getElementById("sortableList"), {
        animation: 150,
        handle: ".card",
      });

      // --- ÂúñÁâáÈ†êË¶Ω ---
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.getElementById("imgPreview");
            img.src = e.target.result;
            img.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // --- CRUD ---
      function openModal(isEdit = false) {
        document.getElementById("editModal").style.display = "flex";
        if (!isEdit) {
          document.getElementById("itemId").value = "";
          document.getElementById("inputTime").value = "12:00";
          document.getElementById("inputCategory").value = "‰∫§ÈÄö";
          document.getElementById("inputTitle").value = "";
          document.getElementById("inputMemo").value = "";
          document.getElementById("inputPrice").value = "";
          document.getElementById("inputMap").value = "";
          document.getElementById("inputImage").value = "";
          document.getElementById("imgPreview").style.display = "none";
          document.getElementById("imgPreview").src = "";
        }
      }
      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function editItem(id) {
        const item = itinerary.find((i) => i.id === id);
        if (!item) return;
        openModal(true);
        document.getElementById("itemId").value = item.id;
        document.getElementById("inputTime").value = item.time;
        document.getElementById("inputCategory").value =
          item.category || "‰∫§ÈÄö";
        document.getElementById("inputTitle").value = item.title;
        document.getElementById("inputMemo").value = item.memo;
        document.getElementById("inputPrice").value = item.price;
        document.getElementById("inputMap").value = item.mapUrl || "";

        const imgPreview = document.getElementById("imgPreview");
        if (item.image) {
          imgPreview.src = item.image;
          imgPreview.style.display = "block";
        } else {
          imgPreview.style.display = "none";
        }
      }

      function saveItem() {
        const id = document.getElementById("itemId").value;
        const fileInput = document.getElementById("inputImage");
        let currentImage = "";

        // ‰øùÁïôÂéüÊú¨ÁöÑÊòéÁ¥∞ (expenses)Ôºå‰∏çË¢´Ë¶ÜËìã
        let currentExpenses = [];
        if (id) {
          const existingItem = itinerary.find((i) => i.id == id);
          if (existingItem) {
            currentImage = existingItem.image;
            currentExpenses = existingItem.expenses || [];
          }
        }

        const performSave = (base64Image) => {
          const newItem = {
            id: id ? parseInt(id) : Date.now(),
            date: currentDate,
            time: document.getElementById("inputTime").value,
            category: document.getElementById("inputCategory").value,
            title: document.getElementById("inputTitle").value,
            memo: document.getElementById("inputMemo").value,
            expenses: currentExpenses, // ÈÄôË£°ÂæàÈáçË¶ÅÔºö‰øùÁïôÊòéÁ¥∞
            mapUrl: document.getElementById("inputMap").value,
            image: base64Image,
          };

          if (id) {
            const idx = itinerary.findIndex((i) => i.id == id);
            itinerary[idx] = newItem;
          } else {
            itinerary.push(newItem);
          }

          try {
            localStorage.setItem(
              "seoul2026_text_v1",
              JSON.stringify(itinerary)
            );
            closeModal();
            renderList();
          } catch (e) {
            alert("ÂÑ≤Â≠òÂ§±ÊïóÔºÅÂúñÁâáÂèØËÉΩÈÅéÂ§ß„ÄÇ");
          }
        };

        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            performSave(e.target.result);
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          performSave(currentImage);
        }
      }

      function deleteItem() {
        const id = document.getElementById("itemId").value;
        if (!id) return closeModal();
        if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü")) {
          itinerary = itinerary.filter((i) => i.id != id);
          localStorage.setItem("seoul2026_text_v1", JSON.stringify(itinerary));
          closeModal();
          renderList();
        }
      }

      renderTabs();
      renderList();

      // --- Ë®òÂ∏≥ÂäüËÉΩÈÇèËºØ (Êñ∞Â¢û) ---
      let currentExpenseItemId = null;

      function openExpenseModal(id, event) {
        if (event) event.stopPropagation(); // Èò≤Ê≠¢ÂêåÊôÇÊâìÈñãË°åÁ®ãÁ∑®ËºØ
        currentExpenseItemId = id;

        const item = itinerary.find((i) => i.id === id);
        if (!item) return;

        document.getElementById(
          "expenseSubtitle"
        ).innerText = `Ë°åÁ®ãÔºö${item.title}`;
        renderExpenseList(item);
        document.getElementById("expenseModal").style.display = "flex";

        // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê¨Ñ‰Ωç
        document.getElementById("newExpenseName").value = "";
        document.getElementById("newExpenseAmount").value = "";
      }

      function closeExpenseModal() {
        document.getElementById("expenseModal").style.display = "none";
        currentExpenseItemId = null;
      }

      function renderExpenseList(item) {
        const list = document.getElementById("expenseList");
        list.innerHTML = "";

        let total = 0;
        // Â¶ÇÊûúÊ≤íÊúâ expenses Èô£ÂàóÂ∞±ÂàùÂßãÂåñ‰∏ÄÂÄã
        if (!item.expenses) item.expenses = [];

        item.expenses.forEach((exp, index) => {
          total += parseInt(exp.amount);
          const div = document.createElement("div");
          div.className = "expense-item";
          div.innerHTML = `
            <div class="expense-name">${exp.name}</div>
            <div style="display:flex; align-items:center;">
                <span class="expense-amount">¬• ${parseInt(
                  exp.amount
                ).toLocaleString()}</span>
                <button class="btn-remove-expense" onclick="removeExpense(${index})">√ó</button>
            </div>
        `;
          list.appendChild(div);
        });
        document.getElementById(
          "expenseTotalDisplay"
        ).innerText = `‚Ç© ${total.toLocaleString()}`;
      }

      function addExpense() {
        if (!currentExpenseItemId) return;
        const name = document.getElementById("newExpenseName").value;
        const amount = document.getElementById("newExpenseAmount").value;

        if (!amount) return;

        const idx = itinerary.findIndex((i) => i.id === currentExpenseItemId);
        if (idx !== -1) {
          if (!itinerary[idx].expenses) itinerary[idx].expenses = [];

          itinerary[idx].expenses.push({
            name: name || "ÂÖ∂‰ªñ",
            amount: parseInt(amount),
          });

          // ÂÑ≤Â≠ò‰∏¶Êõ¥Êñ∞Áï´Èù¢
          localStorage.setItem("seoul2026_text_v1", JSON.stringify(itinerary));
          renderExpenseList(itinerary[idx]);
          renderList(); // Êõ¥Êñ∞Â§ñÂ±§ÁöÑÁ∏ΩÈáëÈ°ç

          // Ê∏ÖÁ©∫ÈáëÈ°çÊ¨Ñ‰ΩçÊñπ‰æøËº∏ÂÖ•‰∏ã‰∏ÄÁ≠Ü
          document.getElementById("newExpenseName").value = "";
          document.getElementById("newExpenseAmount").value = "";
        }
      }

      function removeExpense(expenseIndex) {
        if (!currentExpenseItemId) return;
        const idx = itinerary.findIndex((i) => i.id === currentExpenseItemId);
        if (idx !== -1) {
          itinerary[idx].expenses.splice(expenseIndex, 1);
          localStorage.setItem("seoul2026_text_v1", JSON.stringify(itinerary));
          renderExpenseList(itinerary[idx]);
          renderList();
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Seoul Trip 2026</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Serif+KR:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
      :root {
        --bg-paper: #f8fafb;
        --text-primary: #1f3a52; /* æ·±æ™®é­¯å£«è— */
        --text-secondary: #537791;
        --text-accent: #8aa6bf;
        --bg-white: #ffffff;
        --border-color: #e0e0e0;

        --font-main: "Noto Serif KR", "Noto Serif TC", serif;
        --font-num: "Times New Roman", Times, serif;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0 auto;
        max-width: 480px;
        min-height: 100vh;
        font-family: var(--font-main);
        background-color: var(--bg-paper);
        color: var(--text-primary);
        position: relative;
        padding-bottom: 120px;
      }

      /* --- Header --- */
      header {
        position: relative;
        min-height: 200px;
        background-image: url("https://images.unsplash.com/photo-1598983870677-01e226156732?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80");
        background-size: cover;
        background-position: top center;
        background-repeat: no-repeat;
        background-color: var(--bg-paper);
        overflow: hidden;
      }

      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        background: linear-gradient(
          to bottom,
          rgba(248, 250, 251, 0) 0%,
          rgba(248, 250, 251, 0.4) 30%,
          rgba(248, 250, 251, 0.95) 70%,
          rgba(248, 250, 251, 1) 100%
        );
        z-index: 1;
      }

      .header-content-wrapper,
      .date-section {
        position: relative;
        z-index: 2;
        padding: 0 24px;
      }

      .header-content-wrapper {
        padding-top: 30px; /* é€™è£¡æ”¹å°ï¼Œå…§å®¹å°±æœƒå¾€ä¸Šç§» */
        margin-bottom: 20px;
      }

      .date-display {
        font-family: var(--font-num);
        font-size: 15px;
        letter-spacing: 1px;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .real-time {
        font-family: var(--font-num);
        font-size: 76px;
        line-height: 1;
        color: var(--text-primary);
        margin-bottom: 15px;

        font-weight: 550;

        text-shadow: 0 10px 30px rgba(248, 250, 251, 0.8);
      }

      .trip-title {
        font-size: 34px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: 2px;
        margin-bottom: 15px;
      }

      .info-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .location-badge,
      .weather-widget {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
        background: rgba(255, 255, 255, 0.6);
        padding: 8px 14px;
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        font-weight: 600;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
      }
      .weather-widget {
        gap: 8px;
      }
      .weather-temp {
        font-family: var(--font-num);
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* --- Date Area --- */
      .date-section {
        padding-bottom: 25px;
      }
      .date-tabs {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scrollbar-width: none;
        padding: 5px;
      }
      .date-tabs::-webkit-scrollbar {
        display: none;
      }

      .tab {
        min-width: 68px;
        height: 75px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 1);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(31, 58, 82, 0.05);
        backdrop-filter: blur(5px);
      }
      .tab.active {
        background: var(--text-primary);
        color: #fff;
        border-color: var(--text-primary);
        box-shadow: 0 8px 25px rgba(31, 58, 82, 0.25);
        transform: translateY(-3px);
      }
      .tab span:first-child {
        font-size: 12px;
        font-family: var(--font-num);
        margin-bottom: 5px;
        opacity: 0.9;
      }
      .tab span:last-child {
        font-size: 18px;
        font-weight: 600;
        font-family: var(--font-num);
      }

      /* --- Timeline & Card æ–°æ¨£å¼ --- */
      .timeline-container {
        padding: 30px 24px;
        position: relative;
        background: var(--bg-paper);
        border-top: 1px solid #eef2f5;
      }
      /* å·¦å´å‚ç›´ç·š */
      .timeline-container::before {
        content: "";
        position: absolute;
        left: 35px;
        top: 30px;
        bottom: 0;
        width: 2px;
        background: #e0e0e0;
        z-index: 0;
      }

      .timeline-item {
        display: flex;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
        padding-left: 30px; /* é…åˆå·¦å´ç·šæ¢ç¸®æ’ */
      }

      /* åœ“é» */
      .timeline-item::before {
        content: "";
        position: absolute;
        left: 6px;
        top: 25px;
        width: 10px;
        height: 10px;
        background: var(--text-primary);
        border-radius: 50%;
        z-index: 2;
        border: 2px solid var(--bg-paper);
      }

      /* å¡ç‰‡æœ¬é«” */
      .card {
        flex: 1;
        background: #fff;
        padding: 20px;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border-left: 4px solid var(--text-primary); /* å·¦å´æ·±è‰²ç²—ç·š */
        cursor: grab;
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
      }
      .card:active {
        cursor: grabbing;
        transform: scale(0.99);
      }

      /* ç¬¬ä¸€è¡Œï¼šæ™‚é–“ + æ¨™ç±¤ + åƒ¹æ ¼æ¡† */
      .card-top-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      .card-time {
        font-family: var(--font-num);
        font-size: 24px;
        font-weight: 500;
        color: var(--text-primary);
        margin-right: 12px;
        line-height: 1;
      }
      .card-tag {
        font-size: 11px;
        padding: 3px 8px;
        background: #4a6e87;
        color: #fff;
        border-radius: 4px;
        font-weight: 500;
        letter-spacing: 1px;
      }
      .card-price-box {
        margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
        border: 1px solid var(--text-primary);
        padding: 2px 8px;
        font-family: var(--font-num);
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
      }

      /* ç¬¬äºŒè¡Œï¼šå¤§æ¨™é¡Œ */
      .card-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 15px;
        line-height: 1.4;
        letter-spacing: 0.5px;
      }

      /* å…§å®¹èˆ‡åœ–ç‰‡ */
      .card-detail {
        font-size: 14px;
        color: #7a92a5;
        line-height: 1.6;
        margin-bottom: 10px;
        white-space: pre-line;
      }
      .card-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
        display: none;
      }

      /* æœ€ä¸‹æ–¹ï¼šåœ°åœ–æœå°‹åˆ— */
      .card-map-row {
        border-top: 1px solid #eee;
        padding-top: 12px;
        margin-top: auto;
      }
      .map-link {
        text-decoration: none;
        color: #666;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
      }
      .map-link:hover {
        color: var(--text-primary);
      }

      .price-badge {
        font-family: var(--font-num);
        font-weight: 700;
        color: var(--text-primary);
        font-size: 15px;
      }

      /* --- Footer --- */
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        padding: 16px 24px;
        border-top: 1px solid #eef2f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 480px;
        margin: 0 auto;
        z-index: 100;
      }
      .total-price {
        font-family: var(--font-num);
        font-size: 24px;
        color: var(--text-primary);
        font-weight: 700;
      }
      .fab {
        width: 52px;
        height: 52px;
        background: var(--text-primary);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        box-shadow: 0 8px 25px rgba(31, 58, 82, 0.3);
        cursor: pointer;
      }

      /* --- Modal (ç·Šæ¹Šç‰ˆæ¨£å¼) --- */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(31, 58, 82, 0.4);
        z-index: 200;
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      }
      .modal-box {
        background: #fff;
        width: 90%;
        max-width: 380px;
        padding: 20px; /* ç¸®å°å…§è· */
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        border-radius: 16px;
        max-height: 95vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .modal-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .btn-delete {
        color: #e74c3c;
        background: none;
        border: none;
        font-size: 13px;
        cursor: pointer;
        font-family: var(--font-main);
      }

      /* ç·Šæ¹Šæ’åˆ—è¨­å®š */
      .input-row {
        display: flex;
        gap: 20px;
        margin-bottom: 8px;
      }
      .input-group {
        margin-bottom: 8px;
        flex: 1;
        min-width: 0; /* é—œéµï¼šé˜²æ­¢å…§å®¹æ’é–‹å°è‡´é‡ç–Š */
      }
      .input-group label {
        display: block;
        font-size: 11px;
        color: #888;
        margin-bottom: 4px;
        font-weight: 600;
      }

      /* ä¿®æ”¹é€™ä¸€æ®µ CSS */
      .modal-input,
      .modal-select {
        width: 100%;
        height: 42px; /* é—œéµï¼šå¼·åˆ¶è¨­å®šé«˜åº¦ï¼Œè§£æ±ºå°é½Šå•é¡Œ */
        line-height: 42px; /* è®“æ–‡å­—å‚ç›´ç½®ä¸­ */
        padding: 0 8px; /* åªè¦å·¦å³å…§è·ï¼Œä¸Šä¸‹äº¤çµ¦ height æ§åˆ¶ */
        border: 1px solid #e0e0e0;
        font-family: var(--font-main);
        border-radius: 6px;
        background: #fafcfd;
        font-size: 14px;
        appearance: none; /* ç§»é™¤æ‰‹æ©Ÿé è¨­çš„ç«‹é«”æ¨£å¼ */
        -webkit-appearance: none; /* é‡å° iOS Safari */
        color: #333;
      }

      /* é‡å°ã€Œåˆ†é¡é¸å–®ã€ç‰¹åˆ¥è¨­å®šç½®ä¸­ */
      .modal-select {
        text-align: center;
        text-align-last: center; /* è®“ iOS Safari é¸å–®æ–‡å­—ä¹Ÿèƒ½ç½®ä¸­ */
      }

      /* å‚™è¨»æ¬„å¦å¤–è¨­å®š (å› ç‚ºå®ƒéœ€è¦æ¯”è¼ƒé«˜) */
      .modal-textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e0e0e0;
        font-family: var(--font-main);
        border-radius: 6px;
        background: #fafcfd;
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
        color: #333;
      }

      .modal-textarea {
        resize: vertical;
        min-height: 50px; /* ç¸®å°å‚™è¨»æ¬„é«˜åº¦ */
      }
      .modal-input:focus,
      .modal-select:focus,
      .modal-textarea:focus {
        border-color: var(--text-primary);
        background: #fff;
        outline: none;
      }

      .file-upload-wrapper {
        position: relative;
        margin-bottom: 8px;
        border: 1px dashed #ccc;
        border-radius: 6px;
        padding: 12px; /* ç¸®å°ä¸Šå‚³å€ */
        text-align: center;
        cursor: pointer;
        background: #fafcfd;
      }
      .file-preview {
        max-width: 100%;
        max-height: 100px;
        margin-top: 5px;
        display: none;
        border-radius: 4px;
      }

      .btn-save {
        width: 100%;
        padding: 12px;
        background: var(--text-primary);
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        margin-top: 5px;
        font-family: var(--font-main);
      }

      /* --- æ¶ˆè²»æ˜ç´°è¦–çª—æ¨£å¼ (æ–°å¢) --- */
      .expense-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .expense-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f3a52;
        border-bottom: 3px solid #1f3a52;
        display: inline-block;
        padding-bottom: 5px;
      }
      .expense-subtitle {
        font-size: 13px;
        color: #888;
        margin-top: 8px;
      }

      .expense-list {
        border-top: 1px dotted #ccc;
        border-bottom: 1px dotted #ccc;
        padding: 15px 0;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
      }
      .expense-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px dotted #eee;
      }
      .expense-name {
        font-size: 15px;
        color: #333;
      }
      .expense-amount {
        font-family: "Playfair Display", serif;
        font-weight: 600;
        color: #333;
        margin-right: 10px;
      }
      .btn-remove-expense {
        color: #ccc;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 18px;
      }
      .btn-remove-expense:hover {
        color: #e74c3c;
      }

      .expense-input-area {
        background: #fafcfd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #eee;
      }
      .expense-input-row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .btn-add-expense {
        background: #1f3a52;
        color: white;
        border: none;
        border-radius: 4px;
        width: 60px;
        cursor: pointer;
      }

      .expense-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        font-weight: 700;
        border-top: 2px solid #1f3a52;
        padding-top: 15px;
      }
      .expense-total-amount {
        font-family: "Playfair Display", serif;
        color: #1f3a52;
        font-size: 22px;
      }

      /* --- ç·¨è¼¯é †åºæ¨¡å¼æ¨£å¼ --- */
      .sorting-mode .card {
        border-left: 4px solid #e74c3c; /* å·¦é‚Šè®Šç´…è‰²æç¤º */
        background-color: #fffdfd;
        animation: shake 0.3s; /* è¼•å¾®æŠ–å‹•æç¤º */
      }
      /* è®“æŒ‰éˆ•è®Šè‰²çš„æ¨£å¼ */
      .btn-sorting-active {
        background-color: #8aa6bf !important;
        color: white !important;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-2px);
        }
        50% {
          transform: translateX(2px);
        }
        100% {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content-wrapper">
        <div class="date-display" id="currentDate">Loading...</div>
        <div class="real-time" id="clock">00:00</div>
        <div class="trip-title">é¦–çˆ¾ Seoul</div>

        <div class="info-row">
          <div class="location-badge" id="locationBadge">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span id="locationText">å®šä½ä¸­...</span>
          </div>
          <div class="weather-widget">
            <div class="weather-icon" id="weatherIcon">âŒ›</div>
            <div class="weather-temp" id="weatherTemp">--Â°</div>
          </div>
        </div>
      </div>

      <div class="date-section">
        <div class="date-tabs" id="dateTabs"></div>
      </div>
    </header>

    <div class="timeline-container">
      <div
        style="display: flex; justify-content: flex-end; margin-bottom: 15px"
      >
        <button
          id="sortBtn"
          onclick="toggleSortMode()"
          style="
            background: none;
            border: 1px solid #8aa6bf;
            color: #8aa6bf;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
          "
        >
          <span>â‡„</span> ç·¨è¼¯é †åº
        </button>
      </div>

      <div id="sortableList"></div>
    </div>

    <div class="footer">
      <div>
        <div
          style="
            font-size: 11px;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-bottom: 4px;
            font-weight: 600;
          "
        >
          ESTIMATED TOTAL
        </div>
        <div class="total-price" id="totalPrice">â‚© 0</div>
      </div>
      <div class="fab" onclick="openModal()">+</div>
    </div>

    <div
      class="modal-overlay"
      id="expenseModal"
      onclick="if(event.target===this) closeExpenseModal()"
    >
      <div class="modal-box">
        <div class="expense-header">
          <div class="expense-title">æ¶ˆè²»æ˜ç´°</div>
          <div class="expense-subtitle" id="expenseSubtitle">è¡Œç¨‹ï¼š--</div>
        </div>

        <div class="expense-list" id="expenseList"></div>

        <div class="expense-input-area">
          <div class="input-group" style="margin-bottom: 0">
            <input
              type="text"
              class="modal-input"
              id="newExpenseName"
              placeholder="é …ç›®ï¼ˆä¾‹ï¼šåˆé¤ï¼‰"
              lang="zh-TW"
            />
          </div>
          <div class="expense-input-row">
            <input
              type="number"
              class="modal-input"
              id="newExpenseAmount"
              placeholder="é‡‘é¡"
            />
            <button class="btn-add-expense" onclick="addExpense()">å…¥å¸³</button>
          </div>
        </div>

        <div class="expense-total">
          <span>åˆè¨ˆ</span>
          <span class="expense-total-amount" id="expenseTotalDisplay">â‚© 0</span>
        </div>
      </div>
    </div>

    <div
      class="modal-overlay"
      id="editModal"
      onclick="if(event.target===this) closeModal()"
    >
      <div class="modal-box">
        <div class="modal-header">
          <div class="modal-title">è¡Œç¨‹ç·¨è¼¯</div>
          <button class="btn-delete" onclick="deleteItem()">ğŸ—‘ åˆªé™¤</button>
        </div>

        <input type="hidden" id="itemId" />

        <div class="input-row" style="display: flex; gap: 12px">
          <div class="input-group" style="flex: 0 0 35%; min-width: 0">
            <label>æ™‚é–“</label>
            <input
              type="time"
              class="modal-input"
              id="inputTime"
              style="padding-left: 5px; padding-right: 0; text-align: center"
            />
          </div>

          <div class="input-group" style="flex: 1; min-width: 0">
            <label>åˆ†é¡</label>
            <select class="modal-select" id="inputCategory">
              <option value="äº¤é€š">äº¤é€š</option>
              <option value="åˆé¤">åˆé¤</option>
              <option value="æ™šé¤">æ™šé¤</option>
              <option value="è³¼ç‰©é€›è¡—">è³¼ç‰©é€›è¡—</option>
              <option value="æ™¯é»">æ™¯é»</option>
              <option value="å½ˆæ€§">å½ˆæ€§</option>
              <option value="Reserved">Reserved</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>æ¨™é¡Œ</label>
          <input
            type="text"
            class="modal-input"
            id="inputTitle"
            placeholder="ä¾‹ï¼šæ˜æ´æ›éŒ¢"
          />
        </div>

        <div class="input-group">
          <label>åœ°åœ–é€£çµ (URL)</label>
          <input
            type="text"
            class="modal-input"
            id="inputMap"
            placeholder="Naver Map é€£çµ"
          />
        </div>

        <div class="input-group">
          <label>å‚™è¨»</label>
          <textarea
            class="modal-textarea"
            id="inputMemo"
            placeholder="è©³ç´°è³‡è¨Š..."
          ></textarea>
        </div>

        <div class="input-group">
          <label>åœ–ç‰‡ (é»æ“Šä¸Šå‚³)</label>
          <div
            class="file-upload-wrapper"
            onclick="document.getElementById('inputImage').click()"
          >
            <span style="font-size: 12px; color: #888">é¸æ“‡åœ–ç‰‡</span>
            <input
              type="file"
              id="inputImage"
              style="display: none"
              accept="image/*"
              onchange="previewImage(this)"
            />
            <img id="imgPreview" class="file-preview" />
          </div>
        </div>

        <button class="btn-save" onclick="saveItem()">å„²å­˜</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
      // ---------------------------------------------------------
      // 1. Firebase è¨­å®š (è«‹æŠŠé€™è£¡æ›æˆä½ å‰›å‰›åœ¨ Firebase ç¶²é è¤‡è£½çš„å…§å®¹)
      // ---------------------------------------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyDrZKuMRj9Cp5hzmmujEfgVR5C0HGskaBA",
        authDomain: "seoul-travel-planning.firebaseapp.com",
        projectId: "seoul-travel-planning",
        storageBucket: "seoul-travel-planning.firebasestorage.app",
        messagingSenderId: "4137993578",
        appId: "1:4137993578:web:7032ec9e16d70058645113",
        measurementId: "G-SW5PPNY2T3",
      };

      // åˆå§‹åŒ– Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const tripCollection = db.collection("seoul_itinerary_2026");

      // ---------------------------------------------------------
      // 2. å…¨åŸŸè®Šæ•¸
      // ---------------------------------------------------------
      let itinerary = [];
      let currentLat = 37.5665;
      let currentLon = 126.978;
      let currentDate = "1/6";

      const dates = [
        { d: "1/6", w: "Day 1" },
        { d: "1/7", w: "Day 2" },
        { d: "1/8", w: "Day 3" },
        { d: "1/9", w: "Day 4" },
        { d: "1/10", w: "Day 5" },
        { d: "1/11", w: "Day 6" },
        { d: "1/12", w: "Day 7" },
      ];

      // ---------------------------------------------------------
      // 3. æ ¸å¿ƒï¼šç›£è½è³‡æ–™åº« (è‡ªå‹•åŒæ­¥)
      // ---------------------------------------------------------
      tripCollection.onSnapshot(
        (snapshot) => {
          itinerary = [];
          snapshot.forEach((doc) => {
            itinerary.push(doc.data());
          });

          // è³‡æ–™åº«ä¸€è®Šå‹•ï¼Œç•«é¢è‡ªå‹•æ›´æ–°
          renderList();
          updateTotalAmount();
        },
        (error) => {
          console.error("è³‡æ–™åº«é€£ç·šå¤±æ•—:", error);
          alert(
            "é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ config æ˜¯å¦å¡«å¯«æ­£ç¢ºï¼Œä¸¦ç¢ºèª Firestore è¦å‰‡æ˜¯å¦ç‚º Test Mode"
          );
        }
      );

      // ---------------------------------------------------------
      // 4. åŸºæœ¬åŠŸèƒ½ (GPS, Weather, Time)
      // ---------------------------------------------------------
      function initLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              currentLat = pos.coords.latitude;
              currentLon = pos.coords.longitude;
              fetchCityName(currentLat, currentLon);
              fetchWeather(currentLat, currentLon);
            },
            (err) => {
              fetchWeather(currentLat, currentLon);
            }
          );
        } else {
          fetchWeather(currentLat, currentLon);
        }
      }

      async function fetchCityName(lat, lon) {
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=zh-TW`
          );
          const data = await res.json();
          document.getElementById("locationText").innerText =
            data.address.city || data.address.town || "ç›®å‰ä½ç½®";
        } catch (e) {
          document.getElementById("locationText").innerText = "ç›®å‰ä½ç½®";
        }
      }

      async function fetchWeather(lat, lon) {
        try {
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
          );
          const data = await res.json();
          document.getElementById("weatherTemp").innerText = `${Math.round(
            data.current_weather.temperature
          )}Â°C`;
        } catch (e) {}
      }

      function updateTime() {
        const now = new Date();
        document.getElementById("clock").innerText = `${String(
          now.getHours()
        ).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
        const dateStr = `${now.getFullYear()}.${String(
          now.getMonth() + 1
        ).padStart(2, "0")}.${String(now.getDate()).padStart(2, "0")}`;
        document.getElementById(
          "currentDate"
        ).innerText = `${dateStr} (${now.toLocaleDateString("en-US", {
          weekday: "short",
        })})`;
      }

      // ---------------------------------------------------------
      // 5. ç•«é¢æ¸²æŸ“é‚è¼¯
      // ---------------------------------------------------------
      function renderTabs() {
        document.getElementById("dateTabs").innerHTML = dates
          .map(
            (d) => `
            <div class="tab ${
              d.d === currentDate ? "active" : ""
            }" onclick="switchDate('${d.d}')">
                <span>${d.w}</span><span>${d.d}</span>
            </div>
        `
          )
          .join("");
      }

      function renderList() {
        const list = document.getElementById("sortableList");
        list.innerHTML = "";
        const items = itinerary.filter((i) => i.date === currentDate);

        // æ’åº (é¸ç”¨)ï¼šå¦‚æœè¦æŒ‰æ™‚é–“æ’åºï¼Œå¯ä»¥æŠŠä¸‹é¢é€™è¡Œè¨»è§£æ‰“é–‹
        // --- ä¿®æ”¹é€™è£¡ï¼šæ’åºé‚è¼¯ (å„ªå…ˆæ¬Šï¼šè‡ªè¨‚é †åº > æ™‚é–“) ---
        items.sort((a, b) => {
          const indexA = a.sortIndex !== undefined ? a.sortIndex : 9999;
          const indexB = b.sortIndex !== undefined ? b.sortIndex : 9999;

          // å¦‚æœå…©è€…éƒ½æœ‰è‡ªè¨‚é †åºä¸”ä¸åŒï¼Œç…§é †åºæ’
          if (indexA !== indexB) {
            return indexA - indexB;
          }
          // å¦å‰‡ç…§æ™‚é–“æ’
          return a.time.localeCompare(b.time);
        });

        if (items.length === 0)
          list.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa; font-size:14px;">é»æ“Šå³ä¸‹è§’ + æ–°å¢è¡Œç¨‹</div>`;

        items.forEach((item) => {
          // è¨ˆç®—å–®é …ç¸½é¡
          const itemTotal = item.expenses
            ? item.expenses.reduce((sum, e) => sum + parseInt(e.amount), 0)
            : 0;
          const priceText = `â‚© ${itemTotal.toLocaleString()}`;

          const el = document.createElement("div");
          el.className = "timeline-item";
          el.dataset.id = item.id;

          const imgHtml = item.image
            ? `<img src="${item.image}" class="card-image" style="display:block;">`
            : "";

          let mapLinkHtml = "";
          if (item.mapUrl) {
            let finalUrl = item.mapUrl;
            if (!finalUrl.startsWith("http"))
              finalUrl = `http://googleusercontent.com/maps.google.com/search?q=${encodeURIComponent(
                item.mapUrl
              )}`;
            mapLinkHtml = `<div class="card-map-row"><a href="${finalUrl}" target="_blank" class="map-link" onclick="event.stopPropagation()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>æœå°‹åœ°åœ–ï¼š${
              item.mapUrl.length > 10 ? "æŸ¥çœ‹ä½ç½®" : item.mapUrl
            }</a></div>`;
          }

          el.innerHTML = `
            <div class="card" onclick="editItem(${item.id})">
                <div class="card-top-row">
                    <span class="card-time">${item.time}</span>
                    <span class="card-tag">${item.category || "äº¤é€š"}</span>
                    <span class="card-price-box" onclick="openExpenseModal(${
                      item.id
                    }, event)">${priceText}</span>
                </div>
                <div class="card-title">${item.title}</div>
                ${imgHtml}
                <div class="card-detail">${item.memo}</div>
                ${mapLinkHtml}
            </div>
          `;
          list.appendChild(el);
        });
      }

      function updateTotalAmount() {
        let grandTotal = 0;
        itinerary.forEach((i) => {
          if (i.expenses)
            grandTotal += i.expenses.reduce(
              (sum, e) => sum + parseInt(e.amount),
              0
            );
        });
        document.getElementById(
          "totalPrice"
        ).innerText = `â‚© ${grandTotal.toLocaleString()}`;
      }

      function switchDate(d) {
        currentDate = d;
        renderTabs();
        renderList();
      }

      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("imgPreview").src = e.target.result;
            document.getElementById("imgPreview").style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // ---------------------------------------------------------
      // 6. Modal èˆ‡ è³‡æ–™æ“ä½œ (CRUD)
      // ---------------------------------------------------------
      function openModal(isEdit = false) {
        document.getElementById("editModal").style.display = "flex";
        if (!isEdit) {
          document.getElementById("itemId").value = "";
          document.getElementById("inputTime").value = "12:00";
          document.getElementById("inputCategory").value = "äº¤é€š";
          document.getElementById("inputTitle").value = "";
          document.getElementById("inputMemo").value = "";
          document.getElementById("inputMap").value = "";
          document.getElementById("inputImage").value = "";
          document.getElementById("imgPreview").style.display = "none";
        }
      }
      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function editItem(id) {
        const item = itinerary.find((i) => i.id === id);
        if (!item) return;
        openModal(true);
        document.getElementById("itemId").value = item.id;
        document.getElementById("inputTime").value = item.time;
        document.getElementById("inputCategory").value =
          item.category || "äº¤é€š";
        document.getElementById("inputTitle").value = item.title;
        document.getElementById("inputMemo").value = item.memo;
        document.getElementById("inputMap").value = item.mapUrl || "";

        const imgPreview = document.getElementById("imgPreview");
        if (item.image) {
          imgPreview.src = item.image;
          imgPreview.style.display = "block";
        } else {
          imgPreview.style.display = "none";
        }
      }

      function saveItem() {
        const id = document.getElementById("itemId").value;
        const fileInput = document.getElementById("inputImage");

        // 1. æº–å‚™èˆŠè³‡æ–™
        let currentExpenses = [];
        let currentImage = "";
        // ç¢ºä¿ ID æ˜¯å­—ä¸²
        let docId = id ? id.toString() : Date.now().toString();

        if (id) {
          const existingItem = itinerary.find((i) => i.id == id);
          if (existingItem) {
            currentExpenses = existingItem.expenses || [];
            currentImage = existingItem.image || "";
          }
        }

        const performSave = (base64Image) => {
          // 2. æº–å‚™è¦å„²å­˜çš„é€™å€‹è¡Œç¨‹ç‰©ä»¶
          const itemData = {
            id: parseInt(docId),
            date: currentDate,
            time: document.getElementById("inputTime").value,
            category: document.getElementById("inputCategory").value,
            title: document.getElementById("inputTitle").value,
            memo: document.getElementById("inputMemo").value,
            mapUrl: document.getElementById("inputMap").value,
            image: base64Image,
            expenses: currentExpenses,
          };

          // 3. é—œéµä¿®æ”¹ï¼šè‡ªå‹•ä¾ç…§æ™‚é–“æ’åºä¸¦æ›´æ–°æ‰€æœ‰è¡Œç¨‹
          // å…ˆå–å¾—ç•¶å¤©ã€Œé™¤äº†é€™å€‹è¡Œç¨‹ä»¥å¤–ã€çš„æ‰€æœ‰è¡Œç¨‹
          let dayItems = itinerary.filter(
            (i) => i.date === currentDate && i.id != docId
          );

          // æŠŠé€™å€‹è¡Œç¨‹åŠ é€²å»
          dayItems.push(itemData);

          // ä¾ç…§æ™‚é–“æ’åº
          dayItems.sort((a, b) => a.time.localeCompare(b.time));

          // 4. ä½¿ç”¨ Batch (æ‰¹æ¬¡å¯«å…¥) ä¸€æ¬¡æ›´æ–°ç•¶å¤©æ‰€æœ‰è¡Œç¨‹çš„é †åº
          const batch = db.batch();

          dayItems.forEach((item, index) => {
            // è¨­å®šæ–°çš„é †åº (sortIndex)
            const ref = tripCollection.doc(item.id.toString());
            // é€™è£¡æˆ‘å€‘åªæ›´æ–° sortIndex å’Œè©²è¡Œç¨‹çš„è³‡æ–™
            // ç‚ºäº†ä¿éšªï¼Œå¦‚æœæ˜¯ç•¶ä¸‹ç·¨è¼¯çš„ç‰©ä»¶ï¼Œå¯«å…¥å®Œæ•´è³‡æ–™ï¼›å¦‚æœæ˜¯å…¶ä»–ç‰©ä»¶ï¼Œåªæ›´æ–°é †åº
            if (item.id == docId) {
              batch.set(ref, { ...item, sortIndex: index }, { merge: true });
            } else {
              batch.update(ref, { sortIndex: index });
            }
          });

          // 5. é€å‡ºæ›´æ–°
          batch
            .commit()
            .then(() => {
              console.log("å„²å­˜ä¸¦æ’åºæˆåŠŸ");
              closeModal();
            })
            .catch((error) => {
              console.error("å„²å­˜å¤±æ•—", error);
              alert("å„²å­˜å¤±æ•— (å¯èƒ½æ˜¯åœ–ç‰‡å¤ªå¤§ï¼Œé™åˆ¶ 1MB)");
            });
        };

        // è™•ç†åœ–ç‰‡è®€å–
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            performSave(e.target.result);
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          performSave(currentImage);
        }
      }

      function deleteItem() {
        const id = document.getElementById("itemId").value;
        if (!id) return closeModal();
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) {
          tripCollection
            .doc(id.toString())
            .delete()
            .then(() => closeModal())
            .catch((error) => console.error("åˆªé™¤å¤±æ•—", error));
        }
      }

      // ---------------------------------------------------------
      // 7. æ¶ˆè²»æ˜ç´° Modal é‚è¼¯
      // ---------------------------------------------------------
      let currentExpenseItemId = null;

      function openExpenseModal(id, event) {
        if (event) event.stopPropagation();
        currentExpenseItemId = id;
        const item = itinerary.find((i) => i.id === id);
        if (!item) return;

        document.getElementById(
          "expenseSubtitle"
        ).innerText = `è¡Œç¨‹ï¼š${item.title}`;
        renderExpenseList(item);
        document.getElementById("expenseModal").style.display = "flex";
        document.getElementById("newExpenseName").value = "";
        document.getElementById("newExpenseAmount").value = "";
      }

      function closeExpenseModal() {
        document.getElementById("expenseModal").style.display = "none";
        currentExpenseItemId = null;
      }

      function renderExpenseList(item) {
        const list = document.getElementById("expenseList");
        list.innerHTML = "";
        let total = 0;
        if (!item.expenses) item.expenses = [];

        item.expenses.forEach((exp, index) => {
          total += parseInt(exp.amount);
          const div = document.createElement("div");
          div.className = "expense-item";
          div.innerHTML = `
            <div class="expense-name">${exp.name}</div>
            <div style="display:flex; align-items:center;">
                <span class="expense-amount">Â¥ ${parseInt(
                  exp.amount
                ).toLocaleString()}</span>
                <button class="btn-remove-expense" onclick="removeExpense(${index})">Ã—</button>
            </div>
          `;
          list.appendChild(div);
        });
        document.getElementById(
          "expenseTotalDisplay"
        ).innerText = `â‚© ${total.toLocaleString()}`;
      }

      function addExpense() {
        if (!currentExpenseItemId) return;
        const name = document.getElementById("newExpenseName").value;
        const amount = document.getElementById("newExpenseAmount").value;
        if (!amount) return;

        const item = itinerary.find((i) => i.id === currentExpenseItemId);
        if (item) {
          const newExpenses = item.expenses || [];
          newExpenses.push({ name: name || "å…¶ä»–", amount: parseInt(amount) });

          tripCollection
            .doc(item.id.toString())
            .update({
              expenses: newExpenses,
            })
            .then(() => {
              renderExpenseList({ ...item, expenses: newExpenses });
              document.getElementById("newExpenseName").value = "";
              document.getElementById("newExpenseAmount").value = "";
            });
        }
      }

      function removeExpense(expenseIndex) {
        if (!currentExpenseItemId) return;
        const item = itinerary.find((i) => i.id === currentExpenseItemId);
        if (item) {
          const newExpenses = [...item.expenses];
          newExpenses.splice(expenseIndex, 1);

          tripCollection
            .doc(item.id.toString())
            .update({
              expenses: newExpenses,
            })
            .then(() => {
              renderExpenseList({ ...item, expenses: newExpenses });
            });
        }
      }

      // ---------------------------------------------------------
      // 8. å•Ÿå‹•
      // ---------------------------------------------------------
      initLocation();
      setInterval(() => fetchWeather(currentLat, currentLon), 600000);
      setInterval(updateTime, 1000);
      updateTime();
      renderTabs();

      // æ‹–æ›³å¥—ä»¶è¨­å®š (åŠ å…¥ onEnd å„²å­˜åŠŸèƒ½)
      // --- æ‹–æ›³æ’åºåŠŸèƒ½ (åŒ…å«é–‹é—œèˆ‡å„²å­˜) ---
      let sortable = new Sortable(document.getElementById("sortableList"), {
        animation: 150,
        handle: ".card",
        disabled: true, // é è¨­ï¼šç¦æ­¢æ‹–æ›³
        onEnd: function (evt) {
          // æ‹–æ›³çµæŸï¼šå„²å­˜æ–°é †åº
          const itemEls = document.querySelectorAll(".timeline-item");
          const batch = db.batch(); // ä½¿ç”¨ Batch ä¸€æ¬¡å¯«å…¥ï¼Œç¯€çœæ•ˆèƒ½

          itemEls.forEach((el, index) => {
            const id = el.dataset.id;
            // æ‰¾å‡ºå°æ‡‰çš„ item ä¸¦æ›´æ–°æœ¬åœ°è³‡æ–™ (è®“ç•«é¢ä¸æœƒè·³æ‰)
            const item = itinerary.find((i) => i.id == id);
            if (item) item.sortIndex = index;

            // æº–å‚™å¯«å…¥è³‡æ–™åº«
            const docRef = tripCollection.doc(id.toString());
            batch.update(docRef, { sortIndex: index });
          });

          batch.commit().then(() => console.log("é †åºå·²æ›´æ–°"));
        },
      });

      function toggleSortMode() {
        // å–å¾—ç›®å‰ç‹€æ…‹
        const isDisabled = sortable.option("disabled");
        const btn = document.getElementById("sortBtn");
        const list = document.getElementById("sortableList");

        if (isDisabled) {
          // é–‹å•Ÿç·¨è¼¯æ¨¡å¼
          sortable.option("disabled", false);
          btn.innerHTML = "<span>âœ“</span> å®Œæˆ";
          btn.classList.add("btn-sorting-active");
          list.classList.add("sorting-mode");
        } else {
          // é—œé–‰ç·¨è¼¯æ¨¡å¼ (å„²å­˜)
          sortable.option("disabled", true);
          btn.innerHTML = "<span>â‡„</span> èª¿æ•´é †åº";
          btn.classList.remove("btn-sorting-active");
          list.classList.remove("sorting-mode");
        }
      }
    </script>
  </body>
</html>
